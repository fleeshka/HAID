import requests

OLLAMA_API = "http://ollama:11434/api/chat"

def olama_nlp_generate(prompt, temperature=0.7, max_tokens=400):
#     system_prompt = (
#     "Ты — помощник по покупкам и кулинарии. Пользователь прислал сообщение со списком покупок или названием блюда.\n\n"
#     "Твоя задача:\n"
#     "1. Извлеки из сообщения только **съедобные продукты**. Игнорируй бытовую химию, упаковку, лекарства, корм для животных.\n"
#     "2. Если указано блюдо (например, борщ, пицца, паста) — добавь недостающие **ингредиенты**, необходимые для его приготовления.\n"
#     "3. Продукты пиши в нормальной форме (именительный падеж, единственное число): «лук», «помидоры», «яйцо».\n"
#     "4. Не повторяй уже указанные продукты.\n"
#     "5. Укажи, какие продукты добавлены и для какого блюда, коротко: «для борща — капуста, свекла».\n"
#     "6. Формат ответа:\n"
#     "   Продукты из сообщения: <...>\n"
#     "   Добавлено: <...>\n"
#     "   Причина: <...>\n\n"
#     f"Сообщение пользователя: {prompt.strip()}"
# )
    

    system_prompt = (
        "Ты — интеллектуальный помощник покупателя и кулинара. Пользователь прислал сообщение, "
        "в котором может быть:\n"
        "- список покупок (еду и не еду вперемешку),\n"
        "- описание блюда, которое он хочет приготовить,\n"
        "- обе вещи сразу или в свободной форме.\n\n"

        "Твоя задача:\n"
        "1. Извлеки **только съедобные продукты** (еда, напитки, специи, ингредиенты). Исключи всё несъедобное: бытовую химию, лекарства, упаковки, посуду, витамины, корм для животных.\n"
        "Если в товаре упоминаются продукты, но он явно не предназначен для еды (например, шампунь с экстрактом фруктов), игнорируй его."

        "2. Если пользователь упомянул название блюда, определи, какие ингредиенты **обычно требуются для его приготовления**, и добавь их (только если их нет в исходном сообщении).\n"
        "3. Распознавай **неформальные слова и опечатки** — «картошечка» = «картофель», «молочка» = «молоко», «курочка» = «курица».\n"
        "Если в запросе есть несколько частей, например, «купи хлеб, если он для салата», сначала выдели продукты и определись, для какого блюда они нужны."
        "Учитывай разные виды блюд: если это готовое блюдо, полуфабрикаты, закуски, десерты или напитки — корректно добавляй ингредиенты для каждого типа."

        "4. Приводи продукты в нормальной форме (именительный падеж, единственное число, если можно).\n"
        "5. Не дублируй продукты.\n"
        "6. Форматируй результат строго по шаблону:\n\n"
        "Продукты из сообщения: <список через запятую>\n"
        "Добавлено: <добавленные продукты>\n"
        "Причина: <для какого блюда добавлено и что именно>\n\n"
        "Если пользователь не совсем точно сформулировал запрос, постарайся понять, о каких продуктах или блюде идет речь. Например, если сказано «картошка для супа», добавь картошку в список и предложи ингредиенты для супа."
        "Понимай синонимы, диалекты и возможные опечатки. Например: «помидоры» и «помидорчики» — это одно и то же, а также «сир» вместо «сыр» или «лук» вместо «луковица»."


        "Если блюдо указано, но неизвестно, просто скажи 'блюдо не распознано'. "
        "Если добавлять нечего — напиши 'Добавлено: —' и 'Причина: —'"
        f"Сообщение пользователя: {prompt.strip()}"
    )




    payload = {
        "model": "llama3:instruct",  
        "messages": [
            {"role": "user", "content": system_prompt}
        ],
        "temperature": temperature,
        "max_tokens": max_tokens,
        "stream": False
    }

    try:
        response = requests.post(OLLAMA_API, json=payload)
        return response.json()["message"]["content"]
    except requests.exceptions.RequestException as e:
        print(f"Ошибка при запросе к Ollama API: {e}")
        return f"Ошибка при запросе к Ollama API: {e} \n\n Sorry, I encountered an error while processing your request."
